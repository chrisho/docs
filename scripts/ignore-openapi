#!/bin/sh

API_DIRECTORY="api"

# ignore if the api folder not exists or api/swagger.json not exists.
if [ ! -d $API_DIRECTORY ] || [ -z "$(ls $API_DIRECTORY)" ]; then
    exit 0
fi

BEFORE_COMMIT_ID=${DRONE_COMMIT_BEFORE}
AFTER_COMMIT_ID=${DRONE_COMMIT}

FILES=$(git --no-pager diff --name-only ${BEFORE_COMMIT_ID}...${AFTER_COMMIT_ID})

# if the api/swaggers.json has changed
if echo "$FILES" | grep -qE "v(.*)swagger.json"; then
    # perform re-generate and check for dirty files
    yarn clean-api-docs && yarn gen-api-docs
    dirty_files=$(git status --porcelain --untracked-files=no | grep -v "harvester-apis.info.mdx")
    # exit 0 if dirty_file is empty
    if [ -z "$dirty_files" ]; then
        echo "Not any dirty files found."
        git reset --hard HEAD
        exit 0
    fi

    lines_count=$(echo "$dirty_files" | wc -l)
    if [ "$lines_count" -gt 1 ] || [ "$lines_count" -eq 1 ]; then
        echo "Error: Found dirty files. Please resolve the issues before continuing."
        exit 1
    fi

    git reset --hard HEAD
    exit 0
fi

# if the files in the docs/api have changed
if echo "$FILES" | grep -q "$API_DIRECTORY/*.mdx"; then
    exit 0
fi

# The following builds will ignore the openapi builds 
# since the commit code does not contain openapi changes and to speed up the build.

# removes any previously generated documentation files and will build without OpenAPI pages.
yarn clean-api-docs

# update the sidebars.js configuration to identify the id correctly and directory name.
cat << EOF > sidebars.js
/** @type {import('@docusaurus/plugin-content-docs').SidebarsConfig} */
const sidebars = {
  docs: [{ type: 'autogenerated', dirName: '.' }],
  api: [{ type: 'autogenerated', dirName: '.' }]
};
module.exports = sidebars;
EOF

# remove api category.
matching_folders=$(ls versioned_sidebars/version*.json)
for file in versioned_sidebars/version*.json; do
    cat << EOF > $file
{
  "api": [
    {
      "type": "autogenerated",
      "dirName": "."
    }
  ]
}
EOF
done